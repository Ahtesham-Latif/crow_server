<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doctor Schedule</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f0f2f5;
    padding: 20px;
}
.container {
    max-width: 600px;
    margin: auto;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
}
h2 {
    text-align: center;
    color: #2d3748;
    margin-bottom: 20px;
}
.info {
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 20px;
}
.info span {
    color: #2d3748;
    font-weight: 700;
}
label {
    font-weight: 600;
    color: #4a5568;
    display: block;
    margin-bottom: 8px;
}
input {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border-radius: 10px;
    border: 2px solid #e2e8f0;
    margin-bottom: 20px;
}
.slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
}
.slot {
    padding: 12px;
    text-align: center;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    background: white;
    transition: 0.3s;
}
.slot:hover {
    border-color: #667eea;
    background: #f7fafc;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102,126,234,0.2);
}
.alert {
    margin-top: 15px;
    font-weight: 600;
    color: #e53e3e;
}
</style>
</head>

<body>

<div class="container">
    <h2>ðŸ“… Select Appointment Slot</h2>

    <div class="info">
        Category: <span id="categoryName"></span><br>
        Doctor: <span id="doctorName"></span>
    </div>

    <label for="appointmentDate">Select Date</label>
    <input type="date" id="appointmentDate">

    <div id="slotsContainer" class="slots-grid"></div>
    <div id="alert" class="alert"></div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const doctorId = params.get("doctor_id");
const doctorName = params.get("doctor");
const categoryName = params.get("category_name");

document.getElementById("doctorName").textContent = decodeURIComponent(doctorName);
document.getElementById("categoryName").textContent = decodeURIComponent(categoryName);

const dateInput = document.getElementById("appointmentDate");
const slotsContainer = document.getElementById("slotsContainer");
const alertDiv = document.getElementById("alert");

// Prevent past dates
const today = new Date().toISOString().split("T")[0];
dateInput.min = today;

dateInput.addEventListener("change", async () => {
    const selectedDate = dateInput.value;
    slotsContainer.innerHTML = "";
    alertDiv.textContent = "";

    if (!selectedDate) return;

    const day = new Date(selectedDate).getDay();
    if (day === 0 || day === 5 || day === 6) {
        alertDiv.textContent = "ðŸš« No appointments on Friday, Saturday or Sunday.";
        dateInput.value = "";
        return;
    }

    try {
        const res = await fetch(`/get_available_slots/${doctorId}/${selectedDate}`);
        if (!res.ok) throw new Error();

        const slots = await res.json();

        if (slots.length === 0) {
            alertDiv.textContent = "ðŸ“­ No available slots for this date.";
            return;
        }

        slots.forEach(slot => {
            const div = document.createElement("div");
            div.className = "slot";
            div.textContent = slot.time_slot;

            div.onclick = () => {
                // Redirect with schedule_id included
                window.location.href =
                    `/appointment_page?doctor_id=${doctorId}` +
                    `&doctor=${encodeURIComponent(doctorName)}` +
                    `&category_name=${encodeURIComponent(categoryName)}` +
                    `&date=${selectedDate}` +
                    `&slot=${encodeURIComponent(slot.time_slot)}` +
                    `&schedule_id=${slot.schedule_id}`; // <-- key fix
            };

            slotsContainer.appendChild(div);
        });

    } catch (err) {
        console.error(err);
        alertDiv.textContent = "âŒ Failed to load slots.";
    }
});
</script>

</body>
</html>
