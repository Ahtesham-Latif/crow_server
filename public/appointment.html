<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Details - HealthCare</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; color: #2d3748; }
        .container { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .details-summary { background: #edf2f7; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #667eea; }
        label { font-weight: 600; display: block; margin-top: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 2px solid #e2e8f0; box-sizing: border-box; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; font-family: inherit; }
        button { width: 100%; background: #667eea; color: white; padding: 15px; border: none; border-radius: 10px; font-size: 18px; font-weight: 700; cursor: pointer; margin-top: 25px; transition: 0.3s; }
        button:hover { background: #5a67d8; }
        button:disabled { background: #cbd5e0; cursor: not-allowed; }
        .error { color: #e53e3e; font-size: 14px; margin-top: 15px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üìù Booking Details</h2>
        <div class="details-summary">
            <strong>Doctor:</strong> <span id="summary_doctor"></span><br>
            <strong>Date:</strong> <span id="summary_date"></span><br>
            <strong>Time:</strong> <span id="summary_time"></span>
        </div>

        <form id="bookingForm">
            <label>Full Name</label>
            <input type="text" id="name" required placeholder="John Doe">

            <label>Age</label>
            <input type="number" id="age" required min="1" max="120" placeholder="e.g. 25">

            <label>Email</label>
            <input type="email" id="email" required placeholder="john@example.com">

            <label>Gender</label>
            <select id="gender" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select>

            <label>Reason for Visit *</label>
            <select id="reasonVisit" required>
                <option value="">Select reason for visit</option>
            </select>

            <label>Special Request (Optional)</label>
            <textarea id="request" rows="3" placeholder="Any specific details or concerns..."></textarea>

            <button type="submit" id="submitBtn">Confirm Appointment</button>
            <div id="errorMsg" class="error"></div>
        </form>
    </div>

    <script>
        // Reasons by category
        const reasonsByCategory = {
            "General Physician": [
                "Fever & flu treatment",
                "Cold, cough, sore throat",
                "Headache & body pain",
                "Blood pressure management",
                "Diabetes check & control",
                "Stomach pain, acidity, indigestion",
                "General infections",
                "Routine health checkups",
                "Fatigue & weakness",
                "Initial diagnosis & referrals"
            ],
            "Dentist": [
                "Toothache treatment",
                "Cavity filling",
                "Teeth cleaning (scaling & polishing)",
                "Gum disease treatment",
                "Tooth extraction",
                "Root canal treatment",
                "Bad breath treatment",
                "Tooth sensitivity care",
                "Dental checkups",
                "Braces consultation"
            ],
            "Pediatrician": [
                "Child fever & infections",
                "Cold, cough & flu in children",
                "Vaccinations & immunization",
                "Growth & development checkups",
                "Nutrition & diet guidance",
                "Diarrhea & vomiting in children",
                "Skin rashes & allergies",
                "Childhood asthma care",
                "Newborn care",
                "School health certificates"
            ]
        };

        // 1. Get Params from URL
        const params = new URLSearchParams(window.location.search);
        const doctorName = decodeURIComponent(params.get("doctor") || "Doctor");
        const apptDate = params.get("date") || "";
        const apptTime = decodeURIComponent(params.get("slot") || "");
        const scheduleId = params.get("schedule_id");
        const categoryName = params.get("category_name");

        // 2. Display Summary
        document.getElementById("summary_doctor").textContent = doctorName;
        document.getElementById("summary_date").textContent = apptDate;
        document.getElementById("summary_time").textContent = apptTime;

        // 3. Populate Reason for Visit based on category
        const reasonSelect = document.getElementById("reasonVisit");
        if (categoryName && reasonsByCategory[categoryName]) {
            reasonsByCategory[categoryName].forEach(reason => {
                const option = document.createElement('option');
                option.value = reason;
                option.textContent = reason;
                reasonSelect.appendChild(option);
            });
        } else {
            // Fallback if category not found
            const option = document.createElement('option');
            option.value = "General Consultation";
            option.textContent = "General Consultation";
            reasonSelect.appendChild(option);
        }

        // 4. Form Submission
        document.getElementById("bookingForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const btn = document.getElementById("submitBtn");
            const errorDiv = document.getElementById("errorMsg");
            
            errorDiv.textContent = "";
            btn.disabled = true;
            btn.textContent = "Processing...";

            // CRITICAL: Ensure numbers are valid integers before stringifying
            const ageVal = parseInt(document.getElementById("age").value);
            const schedIdVal = parseInt(scheduleId);

            if (isNaN(ageVal) || isNaN(schedIdVal)) {
                errorDiv.textContent = "‚ùå Error: Invalid numeric data (Age or Schedule ID).";
                btn.disabled = false;
                btn.textContent = "Confirm Appointment";
                return;
            }

            const reasonForVisit = document.getElementById("reasonVisit").value;
            const specialRequest = document.getElementById("request").value.trim();
            
            // Combine reason and special request
            const combinedRequest = specialRequest 
                ? `${reasonForVisit} - ${specialRequest}` 
                : reasonForVisit;

            const payload = {
                name: document.getElementById("name").value.trim(),
                age: ageVal,
                email: document.getElementById("email").value.trim(),
                gender: document.getElementById("gender").value,
                doctor_name: doctorName,
                date: apptDate,
                time_slot: apptTime,
                schedule_id: schedIdVal,
                request: combinedRequest
            };

            console.log("Sending payload:", JSON.stringify(payload));

            try {
                const response = await fetch('/book_appointment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const text = await response.text(); // Get raw text first for debugging
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    throw new Error("Server returned non-JSON response: " + text);
                }

                if (response.ok && result.success) {
                    // Redirect to Confirmation Page
                    const successUrl = new URL(window.location.origin + "/confirmation_page");
                    successUrl.searchParams.set("appointment_id", result.appointment_id);
                    successUrl.searchParams.set("patient_id", result.patient_id);
                    successUrl.searchParams.set("patient_name", payload.name);
                    successUrl.searchParams.set("doctor", doctorName);
                    successUrl.searchParams.set("date", apptDate);
                    successUrl.searchParams.set("time", apptTime);
                    window.location.href = successUrl.toString();
                } else {
                    throw new Error(result.message || "Booking failed.");
                }
            } catch (err) {
                console.error("Fetch error:", err);
                errorDiv.textContent = "‚ùå " + err.message;
                btn.disabled = false;
                btn.textContent = "Confirm Appointment";
            }
        });
    </script>
</body>
</html>