<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Category Management</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #f8f9fc; min-height: 100vh; }
  .header { background: white; padding: 20px 40px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
  .logo-container { display: flex; align-items: center; gap: 12px; }
  .logo { width: 48px; height: 48px; background: #4169e1; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; font-weight: bold; }
  .logo-text h1 { font-size: 22px; color: #1a202c; margin-bottom: 0; font-weight: 600; }
  .logo-text p { font-size: 13px; color: #718096; margin-top: 2px; }
  .container { max-width: 900px; margin: 0 auto; padding: 40px; }
  h2 { font-size: 28px; margin-bottom: 20px; color: #1a202c; }
  form { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 40px; }
  label { display: block; font-weight: 600; margin-bottom: 6px; color: #1a202c; }
  input, textarea, select { width: 100%; padding: 10px 12px; margin-bottom: 16px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 15px; }
  button { padding: 12px 24px; font-size: 15px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
  .btn-add { background: #4169e1; color: white; margin-right: 12px; }
  .btn-add:hover { background: #3557c7; }
  .btn-delete { background: #ef4444; color: white; }
  .btn-delete:hover { background: #dc2626; }
  .category-list { margin-top: 20px; }
  .category-item { background: white; padding: 12px 16px; margin-bottom: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .category-item span { font-weight: 500; color: #1a202c; }
</style>
</head>
<body>

<div class="header">
  <div class="logo-container">
    <div class="logo">A</div>
    <div class="logo-text">
      <h1>Admin Panel</h1>
      <p>Category Management</p>
    </div>
  </div>
</div>

<div class="container">
  <h2>Add New Category</h2>
  <form id="addCategoryForm">
    <label for="category_name">Category Name</label>
    <input type="text" id="category_name" name="category_name" required placeholder="e.g. Pediatrician">
    
    <label for="description">Description</label>
    <textarea id="description" name="description" rows="3" required placeholder="Enter description"></textarea>
    
    <button type="submit" class="btn-add">Add Category</button>
  </form>

  <h2>Existing Categories</h2>
  <div id="categories" class="category-list">
    <div class="loading">Loading categories...</div>
  </div>
</div>

<script>
// Simple validation regex (letters, numbers, spaces)
const safePattern = /^[a-zA-Z0-9\s]+$/;

async function loadCategories() {
  const container = document.getElementById("categories");
  try {
    const res = await fetch("/get_categories");
    if (!res.ok) throw new Error("Failed to fetch categories");

    const categories = await res.json();
    container.innerHTML = '';

    if (categories.length === 0) {
      container.innerHTML = '<div class="loading">No categories available</div>';
      return;
    }

    categories.forEach(cat => {
      const div = document.createElement("div");
      div.className = "category-item";
      div.innerHTML = `
        <span>${cat.category_name} - ${cat.description || 'No description'}</span>
        <button class="btn-delete">Delete</button>
      `;
      div.querySelector(".btn-delete").onclick = async () => {
        if(confirm(`Delete category "${cat.category_name}"?`)) {
          const res = await fetch(`/delete_category/${cat.category_id}`, { method: "DELETE" });
          if(res.ok) loadCategories();
          else alert("Failed to delete category");
        }
      };
      container.appendChild(div);
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = '<div class="loading">Error loading categories</div>';
  }
}

document.getElementById("addCategoryForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = document.getElementById("category_name").value.trim();
  const desc = document.getElementById("description").value.trim();

  if(!safePattern.test(name)) return alert("Category name contains invalid characters.");
  if(!safePattern.test(desc.replace(/[\.,!?'"]/g, ''))) return alert("Description contains invalid characters.");

  const res = await fetch("/add_category", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ category_name: name, description: desc })
  });
  const data = await res.json();
  if(data.success) {
    alert("Category added successfully!");
    document.getElementById("addCategoryForm").reset();
    loadCategories();
  } else {
    alert("Failed to add category");
  }
});

loadCategories();
</script>

</body>
</html>
